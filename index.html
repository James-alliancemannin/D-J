<script>
// Year in footer
document.getElementById("year").textContent = new Date().getFullYear();

// Sticky header shrink
const topbar = document.getElementById("topbar");
window.addEventListener("scroll", () => {
  if (window.scrollY > 14) topbar.classList.add("shrink");
  else topbar.classList.remove("shrink");
});

// Character-by-character typing (smooth & natural)
function typeMessage(text, isBot = true, callback = null) {
  const bubble = document.createElement('div');
  bubble.className = `chat-bubble ${isBot ? 'bot' : 'user'}`;
  document.getElementById('chatContainer').appendChild(bubble);
  document.getElementById('chatContainer').scrollTop = 999999;

  let i = 0;
  const interval = setInterval(() => {
    bubble.textContent = text.substring(0, i) + (i < text.length ? '|' : '');
    i++;
    if (i > text.length) {
      clearInterval(interval);
      bubble.textContent = text;
      bubble.classList.add('visible');
      if (callback) setTimeout(callback, 500);
    }
  }, 28 + Math.random() * 42); // 28–70 ms per character
}

// 10 varied error responses for rubbish/invalid input
const errorResponses = [
  "Sorry, that doesn't look right — could you try again?",
  "I didn't catch that. Please type a valid response.",
  "Hmm, that doesn't seem correct. Let's try once more?",
  "I'm sorry, I need a proper answer to continue.",
  "That doesn't look like what I'm expecting — could you rephrase?",
  "Oops, that wasn't quite right. Please try again.",
  "I think there might be a typo — could you enter that again?",
  "Sorry, I didn't understand. Let's try that step again.",
  "That doesn't seem valid. Please provide a clear answer.",
  "Not quite — could you give me the correct information?"
];

// Main questions + phone step
const questions = [
  { q: "We invite you to give us more information here, so we may help with your confidential enquiry.\n\nWhat is your full name and title?", field: "name" },
  { q: "Thank you, {name}. What is the best email address to reach you?", field: "email" },
  { q: "Understood. Could you tell me the main jurisdiction this matter relates to?", field: "jurisdiction" },
  { q: "Perfect. In a few sentences, please outline what you need help with (urgency, concerns, etc.).", field: "summary" },
  {
    q: "If you'd prefer to be contacted by phone, please tell us the best number. Otherwise, just say 'no', 'email only', or leave it blank.",
    field: "phone"
  }
];

let step = 0;
let formData = {};

function addUserMessage(text) {
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble user';
  bubble.textContent = text;
  document.getElementById('chatContainer').appendChild(bubble);
  document.getElementById('chatContainer').scrollTop = 999999;
  bubble.classList.add('visible');
}

function isValidEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
}

function nextQuestion() {
  if (step >= questions.length) {
    typeMessage("Thank you. Your message has been encrypted for your security and we will get back to you shortly.", true, () => {
      document.getElementById('inputArea').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('successScreen').classList.add('show');
    });
    return;
  }

  let question = questions[step].q;
  if (formData.name) question = question.replace('{name}', formData.name.split(' ')[0]);

  typeMessage(question, true, () => {
    document.getElementById('userInput').focus();
  });
}

document.getElementById('nextBtn').addEventListener('click', () => {
  const input = document.getElementById('userInput');
  let value = input.value.trim();

  // Handle empty input
  if (!value && step < questions.length - 1) {
    const randomError = errorResponses[Math.floor(Math.random() * errorResponses.length)];
    typeMessage(randomError, true);
    return;
  }

  // Special handling for phone step
  if (questions[step].field === "phone") {
    const lower = value.toLowerCase();
    if (lower === '' || lower === 'no' || lower === 'none' || lower === 'email' || lower === 'email only') {
      value = 'Email preferred';
      formData.phone = value;
      typeMessage("Understood — we'll stick to email. Thank you.", true, () => {
        input.value = '';
        step++;
        setTimeout(nextQuestion, 700);
      });
      return;
    }
    // Basic phone check (very lenient — just check for digits + optional + or spaces)
    if (!/^[+\d\s()-]{7,20}$/.test(value)) {
      typeMessage("That doesn't look like a valid phone number — could you try again, or say 'no'?", true);
      return;
    }
    formData.phone = value;
    typeMessage("Got it — we'll use this number if needed. Thank you.", true, () => {
      input.value = '';
      step++;
      setTimeout(nextQuestion, 700);
    });
    return;
  }

  // Email validation
  if (questions[step].field === "email" && !isValidEmail(value)) {
    typeMessage("Please enter a valid email address (e.g. name@example.com)", true);
    return;
  }

  addUserMessage(value);
  formData[questions[step].field] = value;

  let reply = "Got it.";
  if (step === 0) reply = `Thank you, ${value.split(' ')[0]}.`;
  else if (step === 1) reply = "Noted.";
  else if (step === 2) reply = "Understood.";
  else if (step === 3) reply = "Thank you — that's helpful.";

  typeMessage(reply, true, () => {
    input.value = '';
    step++;
    setTimeout(nextQuestion, 700);
  });
});

// Reset button — restarts conversation without reload
document.getElementById('resetBtn').addEventListener('click', () => {
  if (confirm("Reset the form and start over?")) {
    document.getElementById('chatContainer').innerHTML = '';
    document.getElementById('inputArea').style.display = 'block';
    document.getElementById('nextBtn').style.display = 'block';
    document.getElementById('resetBtn').style.display = 'block';
    document.getElementById('successScreen').classList.remove('show');
    formData = {};
    step = 0;
    setTimeout(nextQuestion, 400);
  }
});

// Enter key support
document.getElementById('userInput').addEventListener('keypress', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    document.getElementById('nextBtn').click();
  }
});

// Start conversation faster
window.addEventListener('load', () => {
  setTimeout(() => {
    nextQuestion();
  }, 400);
});
</script>
